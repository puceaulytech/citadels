


<!DOCTYPE html>
<html id="htmlId">
<head>
  <meta http-equiv="Content-Type" content="text/html;charset=windows-1252"> 
  <title>Coverage Report > Game</title>
  <style type="text/css">
    @import "../../css/coverage.css";
    @import "../../css/idea.min.css";
  </style>
  <script type="text/javascript" src="../../js/highlight.min.js"></script>
  <script type="text/javascript" src="../../js/highlightjs-line-numbers.min.js"></script>
</head>

<body>
<div class="content">
<div class="breadCrumbs">
Current scope:     <a href="../../index.html">all classes</a>
    <span class="separator">|</span>
    <a href="../index.html">com.github.the10xdevs.citadels.gamestate</a>
</div>

<h1>Coverage Summary for Class: Game (com.github.the10xdevs.citadels.gamestate)</h1>

<table class="coverageStats">
<tr>
  <th class="name">Class</th>
<th class="coverageStat 
">
  Class, %
</th>
<th class="coverageStat 
">
  Method, %
</th>
<th class="coverageStat 
">
  Line, %
</th>
</tr>
<tr>
  <td class="name">Game</td>
<td class="coverageStat">
  <span class="percent">
    100%
  </span>
  <span class="absValue">
    (1/1)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    94.4%
  </span>
  <span class="absValue">
    (17/18)
  </span>
</td>
<td class="coverageStat">
  <span class="percent">
    89.3%
  </span>
  <span class="absValue">
    (108/121)
  </span>
</td>
</tr>

</table>

<br/>
<br/>


<pre>
<code class="sourceCode" id="sourceCode">&nbsp;package com.github.the10xdevs.citadels.gamestate;
&nbsp;
&nbsp;import com.github.the10xdevs.citadels.exceptions.IllegalActionException;
&nbsp;import com.github.the10xdevs.citadels.interaction.actions.RegularTurnAction;
&nbsp;import com.github.the10xdevs.citadels.interaction.actions.RoleTurnAction;
&nbsp;import com.github.the10xdevs.citadels.interaction.behaviors.Behavior;
&nbsp;import com.github.the10xdevs.citadels.interaction.views.GameView;
&nbsp;import com.github.the10xdevs.citadels.interaction.views.SelfPlayerView;
&nbsp;import com.github.the10xdevs.citadels.logging.Logger;
&nbsp;import com.github.the10xdevs.citadels.models.Category;
&nbsp;import com.github.the10xdevs.citadels.models.District;
&nbsp;import com.github.the10xdevs.citadels.models.Role;
&nbsp;
&nbsp;import java.util.*;
&nbsp;
&nbsp;/**
&nbsp; * The main class
&nbsp; */
&nbsp;public class Game {
<b class="fc">&nbsp;    private final List&lt;Player&gt; players = new ArrayList&lt;&gt;();</b>
&nbsp;    private final Deck&lt;District&gt; deck;
&nbsp;    private final Logger logger;
<b class="fc">&nbsp;    private final Set&lt;Role&gt; rolesFacingUp = EnumSet.noneOf(Role.class);</b>
<b class="fc">&nbsp;    private int firstPlayerIndex = 0;</b>
<b class="fc">&nbsp;    private int turn = 1;</b>
&nbsp;    private int currentTurnOrder;
&nbsp;    private Role killedRole;
&nbsp;    private Role stolenRole;
&nbsp;
&nbsp;    /**
&nbsp;     * Constructs a Game with a list of Behaviors that will battle against each other
&nbsp;     *
&nbsp;     * @param behaviors The list of Behaviors
&nbsp;     */
<b class="fc">&nbsp;    public Game(List&lt;Behavior&gt; behaviors, Deck&lt;District&gt; deck, Logger logger) {</b>
<b class="fc">&nbsp;        this.deck = deck;</b>
<b class="fc">&nbsp;        this.logger = logger;</b>
&nbsp;
<b class="fc">&nbsp;        for (Behavior behavior : behaviors) {</b>
<b class="fc">&nbsp;            players.add(new Player(behavior));</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Starts the game
&nbsp;     */
&nbsp;    public Leaderboard start() {
<b class="fc">&nbsp;        this.deck.shuffle();</b>
&nbsp;
&nbsp;        // Give four cards and two gold to each player
<b class="fc">&nbsp;        for (Player player : this.players) {</b>
<b class="fc">&nbsp;            player.incrementGold(2);</b>
<b class="fc">&nbsp;            for (int i = 0; i &lt; 4; i++) {</b>
<b class="fc">&nbsp;                player.getHand().add(this.deck.drawCard());</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;
&nbsp;        try {
&nbsp;            // Main game loop
<b class="fc">&nbsp;            while (!this.isGameOver()) {</b>
<b class="fc">&nbsp;                this.initTurn();</b>
<b class="fc">&nbsp;                this.logger.logTurnStart(this.turn);</b>
<b class="fc">&nbsp;                this.playRoleTurn();</b>
<b class="fc">&nbsp;                this.playRegularTurn();</b>
<b class="fc">&nbsp;                this.determineNextFirstPlayer();</b>
<b class="fc">&nbsp;                this.turn++;</b>
&nbsp;            }
<b class="nc">&nbsp;        } catch (IllegalActionException e) {</b>
<b class="nc">&nbsp;            this.logger.logError(e);</b>
<b class="nc">&nbsp;            System.exit(1);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;
<b class="fc">&nbsp;        Player firstPlayerToFinish = this.players.stream()</b>
<b class="fc">&nbsp;                .sorted(Comparator.comparingInt(player -&gt; player.getCurrentRole().getTurnOrder()))</b>
<b class="fc">&nbsp;                .filter(player -&gt; player.getCity().getSize() == 8)</b>
<b class="fc">&nbsp;                .findFirst()</b>
<b class="fc">&nbsp;                .orElseThrow(() -&gt; new IllegalStateException(&quot;Game is finished but no player has eight built districts&quot;));</b>
&nbsp;
<b class="fc">&nbsp;        Leaderboard leaderboard = new Leaderboard(this.players, firstPlayerToFinish);</b>
<b class="fc">&nbsp;        this.logger.logWinners(leaderboard);</b>
&nbsp;
<b class="fc">&nbsp;        return leaderboard;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Checks if the game has ended
&nbsp;     *
&nbsp;     * @return true if the game is over, false otherwise
&nbsp;     */
&nbsp;    public boolean isGameOver() {
<b class="fc">&nbsp;        for (Player player : players) {</b>
<b class="fc">&nbsp;            if (player.getCity().getSize() &gt;= 8) {</b>
<b class="fc">&nbsp;                return true;</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
<b class="fc">&nbsp;        return false;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Initializes a new turn
&nbsp;     */
&nbsp;    private void initTurn() {
<b class="fc">&nbsp;        this.killedRole = null;</b>
<b class="fc">&nbsp;        this.stolenRole = null;</b>
<b class="fc">&nbsp;        this.currentTurnOrder = 0;</b>
&nbsp;    }
&nbsp;
&nbsp;    private Role drawUntilNotKing(Deck&lt;Role&gt; deck) {
<b class="fc">&nbsp;        Role r = deck.drawCard();</b>
<b class="fc">&nbsp;        while (r == Role.ROI) {</b>
<b class="fc">&nbsp;            deck.enqueueCard(r);</b>
<b class="fc">&nbsp;            r = deck.drawCard();</b>
&nbsp;        }
<b class="fc">&nbsp;        return r;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Makes all the players choose their role
&nbsp;     *
&nbsp;     * @throws IllegalActionException if a player has performed an action that is not permitted
&nbsp;     */
&nbsp;    private void playRoleTurn() throws IllegalActionException {
&nbsp;        // Create a deck all available roles
<b class="fc">&nbsp;        Deck&lt;Role&gt; roles = new Deck&lt;&gt;(Arrays.asList(Role.values()));</b>
<b class="fc">&nbsp;        roles.shuffle();</b>
&nbsp;        // Put a random role facing down
<b class="fc">&nbsp;        Role roleFacingDown = roles.drawCard();</b>
&nbsp;        // Clear roles facing up from last turn
<b class="fc">&nbsp;        this.rolesFacingUp.clear();</b>
&nbsp;        // Put 0, 1 or 2 roles facing up depending on the number of players
<b class="fc">&nbsp;        if (this.players.size() == 5) {</b>
<b class="nc">&nbsp;            this.rolesFacingUp.add(this.drawUntilNotKing(roles));</b>
&nbsp;        }
<b class="fc">&nbsp;        if (this.players.size() == 4) {</b>
<b class="fc">&nbsp;            this.rolesFacingUp.add(this.drawUntilNotKing(roles));</b>
<b class="fc">&nbsp;            this.rolesFacingUp.add(this.drawUntilNotKing(roles));</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        for (int i = 0; i &lt; this.players.size(); i++) {</b>
&nbsp;            // Get next player to play
<b class="fc">&nbsp;            Player player = this.players.get((i + firstPlayerIndex) % this.players.size());</b>
&nbsp;
<b class="fc">&nbsp;            Set&lt;Role&gt; availableRoles = EnumSet.copyOf(roles.getElements());</b>
&nbsp;            // If this is the turn of the seventh player, add the card facing down
<b class="fc">&nbsp;            if (i == 6) {</b>
<b class="nc">&nbsp;                availableRoles.add(roleFacingDown);</b>
&nbsp;            }
<b class="fc">&nbsp;            RoleTurnAction roleTurnAction = new RoleTurnAction(availableRoles);</b>
&nbsp;
&nbsp;            try {
<b class="fc">&nbsp;                player.getBehavior().pickRole(roleTurnAction, new SelfPlayerView(player), new GameView(this));</b>
<b class="nc">&nbsp;            } catch (Exception e) {</b>
<b class="nc">&nbsp;                throw new IllegalActionException(&quot;Player failed to pick role&quot;, e);</b>
<b class="fc">&nbsp;            }</b>
&nbsp;
<b class="fc">&nbsp;            this.logger.logRoleTurnAction(i, player, roleTurnAction);</b>
&nbsp;
<b class="fc">&nbsp;            player.setCurrentRole(roleTurnAction.getPickedRole());</b>
<b class="fc">&nbsp;            if (this.players.size() == 2)</b>
<b class="nc">&nbsp;                roles.remove(roleTurnAction.getDiscardedRole());</b>
<b class="fc">&nbsp;            roles.remove(roleTurnAction.getPickedRole()); // if the 7th player chose the card facing down nothing happens here</b>
&nbsp;        }
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Computes the amount of gold gained by a player according to the number of districts in his city
&nbsp;     * matching his current role
&nbsp;     *
&nbsp;     * @param player The player
&nbsp;     * @return The amount of gold the player is supposed to gain
&nbsp;     */
&nbsp;    private int checkMatchingDistricts(Player player) {
<b class="fc">&nbsp;        int goldReward = 0;</b>
<b class="fc">&nbsp;        Role playerRole = player.getCurrentRole();</b>
&nbsp;
&nbsp;        // Iterate through player&#39;s city districts
<b class="fc">&nbsp;        for (District district : player.getCity().getDistricts()) {</b>
&nbsp;            // Check if the district&#39;s category matches the player&#39;s role
<b class="fc">&nbsp;            if (district.getCategory() == playerRole.getCategory()) {</b>
&nbsp;                // Reward the player with gold (you can adjust the amount as needed)
<b class="fc">&nbsp;                goldReward += 2; // For example, reward 2 gold for each matching district</b>
&nbsp;            }
<b class="fc">&nbsp;        }</b>
&nbsp;
&nbsp;        // Check for School of Magic
<b class="fc">&nbsp;        District schoolOfMagic = new District(&quot;Ecole de magie&quot;, Category.MERVEILLE, 6);</b>
<b class="fc">&nbsp;        if (player.getCurrentRole().getCategory() != null &amp;&amp; player.getCity().getDistricts().contains(schoolOfMagic)) {</b>
<b class="nc">&nbsp;            goldReward += 2;</b>
&nbsp;        }
&nbsp;
<b class="fc">&nbsp;        return goldReward;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Makes all the players play their turn
&nbsp;     *
&nbsp;     * @throws IllegalActionException if a player has performed an action that is not permitted
&nbsp;     */
&nbsp;    private void playRegularTurn() throws IllegalActionException {
&nbsp;        // Sort players according to their role
<b class="fc">&nbsp;        List&lt;Player&gt; sortedPlayers = new ArrayList&lt;&gt;(this.players);</b>
<b class="fc">&nbsp;        sortedPlayers.sort(Comparator.comparingInt(player -&gt; player.getCurrentRole().getTurnOrder()));</b>
&nbsp;
<b class="fc">&nbsp;        for (Player player : sortedPlayers) {</b>
&nbsp;            // If this payer was killed, skip his turn
<b class="fc">&nbsp;            if (player.getCurrentRole() == this.killedRole)</b>
<b class="fc">&nbsp;                continue;</b>
&nbsp;
&nbsp;            // If this player was stolen, give his gold to the thief
<b class="fc">&nbsp;            if (player.getCurrentRole() == this.stolenRole) {</b>
&nbsp;                // Find the thief
<b class="fc">&nbsp;                Optional&lt;Player&gt; thief = this.players.stream()</b>
<b class="fc">&nbsp;                        .filter(p -&gt; p.getCurrentRole() == Role.VOLEUR)</b>
<b class="fc">&nbsp;                        .findFirst();</b>
&nbsp;
<b class="fc">&nbsp;                if (thief.isPresent()) {</b>
&nbsp;                    // Give the stolen player&#39;s gold to the thief
<b class="fc">&nbsp;                    thief.get().incrementGold(player.getGold());</b>
<b class="fc">&nbsp;                    player.setGold(0);</b>
&nbsp;                } else {
<b class="nc">&nbsp;                    throw new IllegalStateException(&quot;A player was stolen but there is no thief&quot;);</b>
&nbsp;                }
&nbsp;            }
&nbsp;
<b class="fc">&nbsp;            if (player.getCurrentRole() == Role.MARCHAND) {</b>
<b class="fc">&nbsp;                player.incrementGold(1);</b>
&nbsp;            }
&nbsp;
&nbsp;            // Give a gold reward to the player
<b class="fc">&nbsp;            int goldReward = this.checkMatchingDistricts(player);</b>
<b class="fc">&nbsp;            player.incrementGold(goldReward);</b>
&nbsp;
<b class="fc">&nbsp;            this.currentTurnOrder = player.getCurrentRole().getTurnOrder();</b>
&nbsp;
<b class="fc">&nbsp;            SelfPlayerView currentPlayerView = new SelfPlayerView(player);</b>
<b class="fc">&nbsp;            RegularTurnAction action = new RegularTurnAction(this, player);</b>
&nbsp;
&nbsp;            try {
<b class="fc">&nbsp;                player.getBehavior().playTurn(action, currentPlayerView, new GameView(this));</b>
<b class="nc">&nbsp;            } catch (Exception e) {</b>
<b class="nc">&nbsp;                throw new IllegalActionException(&quot;Player failed to play turn&quot;, e);</b>
<b class="fc">&nbsp;            }</b>
&nbsp;
<b class="fc">&nbsp;            this.logger.logRegularTurnAction(player, action);</b>
<b class="fc">&nbsp;        }</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Determines who is the next player to play first
&nbsp;     */
&nbsp;    private void determineNextFirstPlayer() {
<b class="fc">&nbsp;        Optional&lt;Player&gt; kingPlayer = this.players.stream()</b>
<b class="fc">&nbsp;                .filter(player -&gt; player.getCurrentRole() == Role.ROI)</b>
<b class="fc">&nbsp;                .findFirst();</b>
&nbsp;
<b class="fc">&nbsp;        kingPlayer.ifPresent(player -&gt; this.firstPlayerIndex = this.players.indexOf(player));</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns the list of players
&nbsp;     *
&nbsp;     * @return The list of players
&nbsp;     */
&nbsp;    public List&lt;Player&gt; getPlayers() {
<b class="fc">&nbsp;        return players;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns the deck
&nbsp;     *
&nbsp;     * @return The deck
&nbsp;     */
&nbsp;    public Deck&lt;District&gt; getDeck() {
<b class="fc">&nbsp;        return deck;</b>
&nbsp;    }
&nbsp;
&nbsp;    /**
&nbsp;     * Returns which turn is currently being played
&nbsp;     *
&nbsp;     * @return The turn currently being played
&nbsp;     */
&nbsp;    public int getTurn() {
<b class="nc">&nbsp;        return turn;</b>
&nbsp;    }
&nbsp;
&nbsp;    public int getCurrentTurnOrder() {
<b class="fc">&nbsp;        return this.currentTurnOrder;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Set&lt;Role&gt; getRolesFacingUp() {
<b class="fc">&nbsp;        return this.rolesFacingUp;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Optional&lt;Role&gt; getKilledRole() {
<b class="fc">&nbsp;        return Optional.ofNullable(this.killedRole);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setKilledRole(Role killedRole) {
<b class="fc">&nbsp;        this.killedRole = killedRole;</b>
&nbsp;    }
&nbsp;
&nbsp;    public Optional&lt;Role&gt; getStolenRole() {
<b class="fc">&nbsp;        return Optional.ofNullable(this.stolenRole);</b>
&nbsp;    }
&nbsp;
&nbsp;    public void setStolenRole(Role stolenRole) {
<b class="fc">&nbsp;        this.stolenRole = stolenRole;</b>
&nbsp;    }
&nbsp;
&nbsp;}
</code>
</pre>
</div>

<script type="text/javascript">
(function() {
    var msie = false, msie9 = false;
    /*@cc_on
      msie = true;
      @if (@_jscript_version >= 9)
        msie9 = true;
      @end
    @*/

    if (!msie || msie && msie9) {
      hljs.highlightAll()
      hljs.initLineNumbersOnLoad();
    }
})();
</script>

<div class="footer">
    
    <div style="float:right;">generated on 2024-02-07 10:35</div>
</div>
</body>
</html>
